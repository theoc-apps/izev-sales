<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Home - Car Sales Dashboard{% endblock %}

{% block content %}
    <h1 class="my-4 text-center">Car Sales Data</h1>

    <div class="row mb-4">
        <div class="col-md-4">
            <label for="vehicle_type">Select Vehicle Type:</label>
            <select name="vehicle_type" id="vehicle_type" class="form-control">
                {% for vt in vehicle_types %}
                <option value="{{ vt }}" {% if vt == selected_vehicle_type %}selected{% endif %}>{{ vt }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="province">Select Province/Territory:</label>
            <select name="province" id="province" class="form-control">
                {% for p in available_provinces %}
                <option value="{{ p }}" {% if p == selected_province %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="vehicle_models">Select Vehicle Models:</label>
            <select name="vehicle_models" id="vehicle_models" multiple="multiple" style="width: 100%;">
                {% for model in vehicle_models %}
                <option value="{{ model }}" {% if model in selected_models %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

        <div id="graph1" class="mb-5"></div>

        <h2 class="my-4 text-center">Top Selling Cars in the Last Three Months</h2>
        <div id="graphs2" class="mb-5"></div>

        <h2 class="my-4 text-center">Sales of Selected Cars by Month</h2>
        <div id="graph3" class="mb-5"></div>

        <h2 class="my-4 text-center">Sales by Province Over Time</h2>
        <div id="graph4" class="mb-5"></div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        $(document).ready(function() {
            // Initialize Select2 for vehicle models and province selection
            $('#vehicle_models').select2({
                placeholder: 'Select vehicle models'
            });

            $('#province').select2({
                placeholder: 'Select province/territory'
            });

            // Function to update graphs
            function updateGraphs() {
                var vehicle_type = $('#vehicle_type').val();
                var vehicle_models = $('#vehicle_models').val();
                var province = $('#province').val();

                $.ajax({
                    url: '/update_graphs',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        'vehicle_type': vehicle_type,
                        'vehicle_models': vehicle_models,
                        'province': province
                    }),
                    success: function(data) {
                        $('#graph1').html(data.graph1);
                        var graphs2_html = '';
                        data.graphs2.forEach(function(item) {
                            graphs2_html += item.graph;
                        });
                        $('#graphs2').html(graphs2_html);
                        $('#graph3').html(data.graph3);
                        $('#graph4').html(data.graph4);
                    }
                });
            }

            // Update graphs when filters change
            $('#vehicle_type, #vehicle_models, #province').change(function() {
                updateGraphs();
            });

            // Initial graph rendering
            updateGraphs();
        });
    </script>
{% endblock %}