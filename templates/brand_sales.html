<!-- templates/brand_sales.html -->
{% extends "base.html" %}

{% block title %}Sales by Car Brand{% endblock %}

{% block content %}
    <h1 class="mb-4 text-center">Sales by Car Brand</h1>
    <!-- New table added here -->
<table class="table table-bordered table-hover">
    <thead class="thead-dark">
        <tr>
            <th rowspan="2">Brand</th>
            <th colspan="{{ months|length }}">Past 6 Months Sales</th>
            <th rowspan="2">Past 6 Months Total</th>
            <th rowspan="2">YTD Total</th>
            <th rowspan="2">Past Year Total</th>
        </tr>
        <tr>
            {% for month in months %}
            <th>{{ month }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for brand in brand_data %}
        <tr class="brand-row" data-brand="{{ brand['Vehicle Make'] }}">
            <td><span class="expand-icon">+</span> {{ brand['Vehicle Make'] }}</td>
            {% for month in month_periods %}
            <td>{{ brand[month]|int }}</td>
            {% endfor %}
            <td>{{ brand['Past 6 Months Total']|int }}</td>
            <td>{{ brand['YTD Total']|int }}</td>
            <td>{{ brand['Past Year Total']|int }}</td>
        </tr>
        {% if model_data[brand['Vehicle Make']] %}
            {% for model in model_data[brand['Vehicle Make']] %}
            <tr class="model-row" data-parent="{{ brand['Vehicle Make'] }}">
                <td>&nbsp;&nbsp;&nbsp;{{ model['Vehicle Model'] }}</td>
                {% for month in month_periods %}
                <td>{{ model[month]|int }}</td>
                {% endfor %}
                <td>{{ model['Past 6 Months Total']|int }}</td>
                <td>{{ model['YTD Total']|int }}</td>
                <td>{{ model['Past Year Total']|int }}</td>
            </tr>
            {% endfor %}
        {% endif %}
        {% endfor %}
    </tbody>
</table>
    <form method="post" class="mb-4" id="date-form">
        <div class="form-row">
            <div class="form-group col-md-5">
                <label for="start_date">Start Month:</label>
                <input type="month" class="form-control" name="start_date" id="start_date" value="{{ start_date }}">
            </div>
            <div class="form-group col-md-5">
                <label for="end_date">End Month:</label>
                <input type="month" class="form-control" name="end_date" id="end_date" value="{{ end_date }}">
            </div>
            <div class="form-group col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary btn-block">Update</button>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12 text-center">
                <button type="button" class="btn btn-secondary m-1" id="ytd-btn">Year to Date</button>
                <button type="button" class="btn btn-secondary m-1" id="last-12-months-btn">Last 12 Months</button>
                <button type="button" class="btn btn-secondary m-1" id="last-6-months-btn">Last 6 Months</button>
                <button type="button" class="btn btn-secondary m-1" id="previous-month-btn">Previous Month</button>
                <button type="button" class="btn btn-secondary m-1" id="latest-month-btn">Latest Month</button>
            </div>
        </div>
    </form>
    <table class="table table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th id="brand-header" class="sortable">Brand</th>
                <th id="total-sales-header" class="sortable">Total Sales</th>
            </tr>
        </thead>
        <tbody id="sales-table-body">
            {% for brand in brand_sales %}
            <tr class="brand-row" data-brand="{{ brand['Vehicle Make'] }}">
                <td>{{ brand['Vehicle Make'] }}</td>
                <td>{{ brand['Number of Cars'] }}</td>
            </tr>
            {% for model in model_sales[brand['Vehicle Make']] %}
            <tr class="model-row" data-parent="{{ brand['Vehicle Make'] }}">
                <td>{{ model['Vehicle Model'] }}</td>
                <td>{{ model['Number of Cars'] }}</td>
            </tr>
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Dashboard</a>
{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function(){
            console.log("brand_sales.js is loaded and ready.");

            // Ensure model rows are hidden (redundant if CSS is applied)
            $('.model-row').hide();
            console.log("Model rows are hidden.");

            // Toggle model rows when a brand row is clicked
            $('.brand-row').click(function(){
                var brand = $(this).data('brand');
                console.log("Brand row clicked: " + brand);
                $('.model-row[data-parent="' + brand + '"]').toggle();
            });

            // Handle shortcut buttons
            const lastAvailableMonth = "{{ last_available_month }}";
            const lastAvailableDate = new Date(lastAvailableMonth + "-01");

            $('#ytd-btn').click(function() {
                const startDate = new Date(lastAvailableDate.getFullYear(), 0, 1);
                $('#start_date').val(startDate.toISOString().slice(0, 7));
                $('#end_date').val(lastAvailableMonth);
                $('#date-form').submit();
            });

            $('#last-12-months-btn').click(function() {
                const startDate = new Date(lastAvailableDate);
                startDate.setMonth(startDate.getMonth() - 11);
                $('#start_date').val(startDate.toISOString().slice(0, 7));
                $('#end_date').val(lastAvailableMonth);
                $('#date-form').submit();
            });

            $('#last-6-months-btn').click(function() {
                const startDate = new Date(lastAvailableDate);
                startDate.setMonth(startDate.getMonth() - 5);
                $('#start_date').val(startDate.toISOString().slice(0, 7));
                $('#end_date').val(lastAvailableMonth);
                $('#date-form').submit();
            });

            $('#latest-month-btn').click(function() {
                $('#start_date').val(lastAvailableMonth);
                $('#end_date').val(lastAvailableMonth);
                $('#date-form').submit();
            });

            $('#previous-month-btn').click(function() {
                const previousMonth = new Date(lastAvailableDate);
                previousMonth.setMonth(previousMonth.getMonth() - 1);
                const previousMonthStr = previousMonth.toISOString().slice(0, 7);
                $('#start_date').val(previousMonthStr);
                $('#end_date').val(previousMonthStr);
                $('#date-form').submit();
            });

            // Sorting functionality
            let sortOrder = {
                brand: 'asc',
                totalSales: 'desc'  // Set default sort order to descending for total sales
            };

            function sortTable(columnIndex, isNumeric, sortOrderKey) {
                const tbody = $('#sales-table-body');
                const rows = tbody.find('tr.brand-row').get();

                rows.sort(function(a, b) {
                    const A = $(a).children('td').eq(columnIndex).text().toUpperCase();
                    const B = $(b).children('td').eq(columnIndex).text().toUpperCase();

                    let comparison = 0;
                    if (isNumeric) {
                        comparison = parseInt(A) - parseInt(B);
                    } else {
                        if (A < B) comparison = -1;
                        if (A > B) comparison = 1;
                    }

                    return sortOrder[sortOrderKey] === 'asc' ? comparison : -comparison;
                });

                $.each(rows, function(index, row) {
                    tbody.append(row);
                    const brand = $(row).data('brand');
                    const modelRows = tbody.find(`tr.model-row[data-parent="${brand}"]`).get();
                    $.each(modelRows, function(index, modelRow) {
                        tbody.append(modelRow);
                    });
                });

                // Toggle sort order for next click
                sortOrder[sortOrderKey] = sortOrder[sortOrderKey] === 'asc' ? 'desc' : 'asc';
            }

            $('#brand-header').click(function() {
                sortTable(0, false, 'brand');
            });

            $('#total-sales-header').click(function() {
                sortTable(1, true, 'totalSales');
            });

            // Initial sort by total sales in descending order
            sortTable(1, true, 'totalSales');
        });
    </script>
{% endblock %}